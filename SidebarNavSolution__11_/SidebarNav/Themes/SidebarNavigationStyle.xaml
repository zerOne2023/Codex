<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:ctrl="clr-namespace:SidebarNav.Controls"
                    xmlns:vm="clr-namespace:SidebarNav.ViewModels"
                    xmlns:conv="clr-namespace:SidebarNav.Converters">

    <conv:BoolToVisibilityConverter x:Key="BoolToVis_Nav"/>
    <conv:InverseBoolToVisibilityConverter x:Key="InvBoolToVis_Nav"/>
    <conv:NullToVisibilityConverter x:Key="NullToVis_Nav"/>

    <!-- ═══════════════════════════════════════════════ -->
    <!-- 超薄滚动条 - 透明轨道按钮                        -->
    <!-- ═══════════════════════════════════════════════ -->
    <Style x:Key="ThinScrollRepeatButton" TargetType="{x:Type RepeatButton}">
        <Setter Property="OverridesDefaultStyle" Value="True"/>
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="Focusable" Value="False"/>
        <Setter Property="IsTabStop" Value="False"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type RepeatButton}">
                    <Rectangle Fill="Transparent" Width="{TemplateBinding Width}" Height="{TemplateBinding Height}"/>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- ═══════════════════════════════════════════════ -->
    <!-- 超薄滚动条 Thumb                                -->
    <!-- ═══════════════════════════════════════════════ -->
    <Style x:Key="ThinScrollThumb" TargetType="{x:Type Thumb}">
        <Setter Property="OverridesDefaultStyle" Value="True"/>
        <Setter Property="IsTabStop" Value="False"/>
        <Setter Property="Width" Value="3"/>
        <Setter Property="MinHeight" Value="16"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type Thumb}">
                    <Border x:Name="thumbBd"
                            Background="{DynamicResource Sidebar.ScrollBarThumb}"
                            CornerRadius="1.5"
                            Width="{TemplateBinding Width}"
                            Opacity="0.45"/>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter TargetName="thumbBd" Property="Opacity" Value="0.75"/>
                            <Setter TargetName="thumbBd" Property="Width" Value="5"/>
                            <Setter TargetName="thumbBd" Property="CornerRadius" Value="2.5"/>
                        </Trigger>
                        <Trigger Property="IsDragging" Value="True">
                            <Setter TargetName="thumbBd" Property="Opacity" Value="0.9"/>
                            <Setter TargetName="thumbBd" Property="Width" Value="5"/>
                            <Setter TargetName="thumbBd" Property="CornerRadius" Value="2.5"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- ═══════════════════════════════════════════════ -->
    <!-- 自定义 ScrollViewer：滚动条叠加在内容右侧上层    -->
    <!-- ═══════════════════════════════════════════════ -->
    <ControlTemplate x:Key="OverlayScrollViewerTemplate" TargetType="{x:Type ScrollViewer}">
        <Grid>
            <!-- 内容铺满 -->
            <ScrollContentPresenter x:Name="PART_ScrollContentPresenter"
                                    CanContentScroll="{TemplateBinding CanContentScroll}"
                                    Margin="{TemplateBinding Padding}"/>
            <!-- 滚动条叠加在右侧，宽度极窄 -->
            <ScrollBar x:Name="PART_VerticalScrollBar"
                       HorizontalAlignment="Right"
                       Orientation="Vertical"
                       Width="6"
                       MinWidth="3"
                       Margin="0,2,1,2"
                       Opacity="0"
                       Value="{Binding VerticalOffset, RelativeSource={RelativeSource TemplatedParent}, Mode=OneWay}"
                       Maximum="{Binding ScrollableHeight, RelativeSource={RelativeSource TemplatedParent}, Mode=OneWay}"
                       ViewportSize="{Binding ViewportHeight, RelativeSource={RelativeSource TemplatedParent}, Mode=OneWay}"
                       Visibility="{Binding ComputedVerticalScrollBarVisibility, RelativeSource={RelativeSource TemplatedParent}}">
                <ScrollBar.Template>
                    <ControlTemplate TargetType="{x:Type ScrollBar}">
                        <Grid Background="Transparent" Width="6" SnapsToDevicePixels="True">
                            <Track x:Name="PART_Track"
                                   IsDirectionReversed="True"
                                   IsEnabled="{TemplateBinding IsMouseOver}">
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Style="{StaticResource ThinScrollRepeatButton}" Command="ScrollBar.PageUpCommand"/>
                                </Track.DecreaseRepeatButton>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Style="{StaticResource ThinScrollRepeatButton}" Command="ScrollBar.PageDownCommand"/>
                                </Track.IncreaseRepeatButton>
                                <Track.Thumb>
                                    <Thumb Style="{StaticResource ThinScrollThumb}" HorizontalAlignment="Right"/>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </ScrollBar.Template>
            </ScrollBar>
        </Grid>
        <ControlTemplate.Triggers>
            <!-- 悬停时淡入 -->
            <Trigger Property="IsMouseOver" Value="True">
                <Trigger.EnterActions>
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="PART_VerticalScrollBar"
                                             Storyboard.TargetProperty="Opacity"
                                             To="1" Duration="0:0:0.12"/>
                        </Storyboard>
                    </BeginStoryboard>
                </Trigger.EnterActions>
                <Trigger.ExitActions>
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="PART_VerticalScrollBar"
                                             Storyboard.TargetProperty="Opacity"
                                             To="0" Duration="0:0:0.6"/>
                        </Storyboard>
                    </BeginStoryboard>
                </Trigger.ExitActions>
            </Trigger>
        </ControlTemplate.Triggers>
    </ControlTemplate>

    <!-- ═══════════════════════════════════════════════ -->
    <!-- 迷你模式 ToolTip 样式                            -->
    <!-- ═══════════════════════════════════════════════ -->
    <Style x:Key="MiniToolTipStyle" TargetType="ToolTip">
        <Setter Property="Background" Value="#1F2937"/>
        <Setter Property="Foreground" Value="#F9FAFB"/>
        <Setter Property="FontSize" Value="12"/>
        <Setter Property="Padding" Value="8,5"/>
        <Setter Property="BorderThickness" Value="0"/>
        <Setter Property="Placement" Value="Right"/>
        <Setter Property="HorizontalOffset" Value="4"/>
        <Setter Property="HasDropShadow" Value="True"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="ToolTip">
                    <Border Background="{TemplateBinding Background}"
                            CornerRadius="6"
                            Padding="{TemplateBinding Padding}">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.18" Color="Black"/>
                        </Border.Effect>
                        <ContentPresenter/>
                    </Border>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- ═══════════════════════════════════════════════ -->
    <!-- SidebarNavigation 主样式                        -->
    <!-- ═══════════════════════════════════════════════ -->
    <Style TargetType="{x:Type ctrl:SidebarNavigation}">
        <Setter Property="Focusable" Value="True"/>
        <Setter Property="Width" Value="{Binding ExpandedWidth, RelativeSource={RelativeSource Self}}"/>
        <Setter Property="SnapsToDevicePixels" Value="True"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type ctrl:SidebarNavigation}">
                    <Border x:Name="PART_RootBorder"
                            Background="{DynamicResource Sidebar.Background}"
                            BorderBrush="{DynamicResource Sidebar.BorderBrush}"
                            BorderThickness="0,0,1,0"
                            CornerRadius="{TemplateBinding CornerRadius}"
                            ClipToBounds="True">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- ═══ Header ═══ -->
                            <ContentPresenter x:Name="HeaderPresenter" Grid.Row="0"
                                              Content="{TemplateBinding HeaderContent}"
                                              ContentTemplate="{TemplateBinding HeaderTemplate}"
                                              Visibility="{Binding HeaderContent, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource NullToVis_Nav}}"/>

                            <!-- ═══ Toggle + Search ═══ -->
                            <StackPanel Grid.Row="1">
                                <ToggleButton x:Name="ToggleBtn"
                                              IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}"
                                              HorizontalAlignment="Center"
                                              Margin="0,8,0,4"
                                              Width="36" Height="36"
                                              Background="Transparent"
                                              BorderThickness="0"
                                              Cursor="Hand"
                                              ToolTip="Toggle Sidebar">
                                    <ToggleButton.Template>
                                        <ControlTemplate TargetType="ToggleButton">
                                            <Border x:Name="tbd" Background="{TemplateBinding Background}" CornerRadius="6">
                                                <Path x:Name="menuIcon"
                                                      Data="M4 6h16M4 12h16M4 18h16"
                                                      Stroke="{DynamicResource Sidebar.IconBrush}"
                                                      StrokeThickness="2"
                                                      StrokeStartLineCap="Round"
                                                      StrokeEndLineCap="Round"
                                                      Width="18" Height="18"
                                                      Stretch="Uniform"
                                                      HorizontalAlignment="Center"
                                                      VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="tbd" Property="Background" Value="{DynamicResource Sidebar.Item.HoverBrush}"/>
                                                    <Setter TargetName="menuIcon" Property="Stroke" Value="{DynamicResource Sidebar.AccentBrush}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </ToggleButton.Template>
                                </ToggleButton>

                                <ctrl:SidebarSearchBox
                                    x:Name="SearchBox"
                                    Text="{Binding ViewModel.SearchText, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                    Placeholder="{Binding ViewModel.SearchPlaceholder, RelativeSource={RelativeSource TemplatedParent}}"
                                    ClearCommand="{Binding ViewModel.ClearSearchCommand, RelativeSource={RelativeSource TemplatedParent}}"
                                    Visibility="{Binding ShowSearchBox, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource BoolToVis_Nav}}"/>
                            </StackPanel>

                            <!-- ═══ Back Button ═══ -->
                            <Button x:Name="BackBtn" Grid.Row="2"
                                    Command="{Binding ViewModel.GoBackCommand, RelativeSource={RelativeSource TemplatedParent}}"
                                    Background="Transparent" BorderThickness="0"
                                    Height="30" Margin="6,2"
                                    HorizontalContentAlignment="Center"
                                    Cursor="Hand"
                                    Visibility="{Binding ShowBackButton, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource BoolToVis_Nav}}">
                                <Button.Template>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="bkbd" Background="Transparent" CornerRadius="4" Padding="6,4">
                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                <Path Data="M20 12H4m0 0l6-6m-6 6l6 6"
                                                      Stroke="{DynamicResource Sidebar.SecondaryForeground}"
                                                      StrokeThickness="1.5"
                                                      Width="14" Height="14"
                                                      Stretch="Uniform"
                                                      VerticalAlignment="Center"/>
                                                <TextBlock x:Name="BackText" Text="Back"
                                                           Foreground="{DynamicResource Sidebar.SecondaryForeground}"
                                                           FontSize="12"
                                                           VerticalAlignment="Center"
                                                           Margin="6,0,0,0"/>
                                            </StackPanel>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="bkbd" Property="Background" Value="{DynamicResource Sidebar.Item.HoverBrush}"/>
                                            </Trigger>
                                            <Trigger Property="IsEnabled" Value="False">
                                                <Setter Property="Opacity" Value="0.3"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Button.Template>
                            </Button>

                            <!-- ═══ 导航项列表（自定义超薄叠加滚动条） ═══ -->
                            <ScrollViewer x:Name="PART_ScrollViewer" Grid.Row="3"
                                          VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Disabled"
                                          Focusable="False"
                                          Padding="0,4"
                                          Template="{StaticResource OverlayScrollViewerTemplate}">

                                <ItemsControl x:Name="PART_ItemsHost"
                                              ItemsSource="{Binding ViewModel.Groups, RelativeSource={RelativeSource TemplatedParent}}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate DataType="{x:Type vm:SidebarGroupViewModel}">
                                            <StackPanel Visibility="{Binding IsVisibleInSearch, Converter={StaticResource BoolToVis_Nav}}">
                                                <!-- 分隔线（迷你模式变短居中） -->
                                                <Rectangle x:Name="GroupSep" Height="1"
                                                           Fill="{DynamicResource Sidebar.SeparatorBrush}"
                                                           Margin="14,6"
                                                           Visibility="{Binding ShowSeparator, Converter={StaticResource BoolToVis_Nav}}"/>

                                                <!-- 分组标题 -->
                                                <TextBlock x:Name="GroupTitle"
                                                           Text="{Binding GroupName}"
                                                           Foreground="{DynamicResource Sidebar.GroupForeground}"
                                                           FontSize="11" FontWeight="SemiBold"
                                                           Margin="18,8,16,4"
                                                           Visibility="{Binding GroupName, Converter={StaticResource NullToVis_Nav}}"/>

                                                <ItemsControl ItemsSource="{Binding Items}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate DataType="{x:Type vm:SidebarItemViewModel}">
                                                            <ctrl:SidebarNavItem DataContext="{Binding}"
                                                                                  Visibility="{Binding IsVisibleInSearch, Converter={StaticResource BoolToVis_Nav}}"/>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </StackPanel>
                                            <DataTemplate.Triggers>
                                                <!-- 迷你模式：隐藏分组标题，分隔线缩短 -->
                                                <DataTrigger Binding="{Binding IsExpanded, RelativeSource={RelativeSource AncestorType={x:Type ctrl:SidebarNavigation}}}" Value="False">
                                                    <Setter TargetName="GroupTitle" Property="Visibility" Value="Collapsed"/>
                                                    <Setter TargetName="GroupSep" Property="Margin" Value="12,4"/>
                                                    <Setter TargetName="GroupSep" Property="Opacity" Value="0.5"/>
                                                </DataTrigger>
                                            </DataTemplate.Triggers>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>

                            <!-- ═══ Footer ═══ -->
                            <ContentPresenter x:Name="FooterPresenter" Grid.Row="4"
                                              Content="{TemplateBinding FooterContent}"
                                              ContentTemplate="{TemplateBinding FooterTemplate}"
                                              Visibility="{Binding FooterContent, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource NullToVis_Nav}}"/>
                        </Grid>
                    </Border>

                    <!-- ═══ 迷你模式触发器 ═══ -->
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsExpanded" Value="False">
                            <Setter TargetName="SearchBox" Property="Visibility" Value="Collapsed"/>
                            <Setter TargetName="HeaderPresenter" Property="Visibility" Value="Collapsed"/>
                            <Setter TargetName="FooterPresenter" Property="Visibility" Value="Collapsed"/>
                            <Setter TargetName="BackBtn" Property="Visibility" Value="Collapsed"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

</ResourceDictionary>
