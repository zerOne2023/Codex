<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:ctrl="clr-namespace:SidebarNav.Controls"
                    xmlns:vm="clr-namespace:SidebarNav.ViewModels"
                    xmlns:conv="clr-namespace:SidebarNav.Converters">

    <conv:BoolToVisibilityConverter x:Key="BoolToVis_Item"/>
    <conv:InverseBoolToVisibilityConverter x:Key="InvBoolToVis_Item"/>
    <conv:LevelToIndentConverter x:Key="LevelIndent" IndentPerLevel="16"/>
    <conv:IconTypeToVisibilityConverter x:Key="IconTypeVis_Item"/>
    <conv:BadgeTypeToVisibilityConverter x:Key="BadgeTypeVis_Item"/>

    <Style TargetType="{x:Type ctrl:SidebarNavItem}">
        <Setter Property="Cursor" Value="Hand"/>
        <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type ctrl:SidebarNavItem}">
                    <StackPanel>
                        <!-- 主行 -->
                        <Border x:Name="ItemBorder"
                                Background="Transparent"
                                CornerRadius="6"
                                Margin="6,1"
                                MinHeight="38"
                                Opacity="0.97">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <!-- 缩进 -->
                                    <ColumnDefinition x:Name="IndentCol" Width="Auto"/>
                                    <!-- 选中指示条 -->
                                    <ColumnDefinition Width="Auto"/>
                                    <!-- 图标区 -->
                                    <ColumnDefinition Width="Auto"/>
                                    <!-- 文本区 -->
                                    <ColumnDefinition Width="*"/>
                                    <!-- 徽章区 -->
                                    <ColumnDefinition Width="Auto"/>
                                    <!-- 展开箭头 -->
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- 缩进占位 -->
                                <Border x:Name="IndentBorder" Grid.Column="0"
                                        Width="{Binding Level, Converter={StaticResource LevelIndent}}"/>

                                <!-- 选中指示条 -->
                                <Rectangle x:Name="Indicator" Grid.Column="1"
                                           Width="3" Height="0"
                                           Opacity="0"
                                           RadiusX="1.5" RadiusY="1.5"
                                           Fill="{DynamicResource Sidebar.IndicatorBrush}"
                                           VerticalAlignment="Center"
                                           Margin="2,0,4,0"/>

                                <!-- 图标 -->
                                <Grid x:Name="IconGrid" Grid.Column="2" Width="36" Height="36">
                                    <Path x:Name="PathIcon"
                                          Data="{Binding IconPathData}"
                                          Fill="{DynamicResource Sidebar.IconBrush}"
                                          Width="{Binding IconSize}" Height="{Binding IconSize}"
                                          Stretch="Uniform"
                                          HorizontalAlignment="Center" VerticalAlignment="Center"
                                          Visibility="{Binding IconType, Converter={StaticResource IconTypeVis_Item}, ConverterParameter=PathData}"/>

                                    <TextBlock x:Name="FontIcon"
                                               Text="{Binding FontIconGlyph}"
                                               FontFamily="{Binding FontIconFamily}"
                                               FontSize="{Binding IconSize}"
                                               Foreground="{DynamicResource Sidebar.IconBrush}"
                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                               Visibility="{Binding IconType, Converter={StaticResource IconTypeVis_Item}, ConverterParameter=FontIcon}"/>

                                    <Image x:Name="ImageIcon"
                                           Width="{Binding IconSize}" Height="{Binding IconSize}"
                                           Stretch="Uniform"
                                           HorizontalAlignment="Center" VerticalAlignment="Center"
                                           Visibility="{Binding IconType, Converter={StaticResource IconTypeVis_Item}, ConverterParameter=Image}"/>
                                </Grid>

                                <!-- 文本 -->
                                <TextBlock x:Name="TitleText" Grid.Column="3"
                                           Text="{Binding Title}"
                                           Foreground="{DynamicResource Sidebar.ForegroundBrush}"
                                           FontSize="13.5" FontWeight="Normal"
                                           VerticalAlignment="Center"
                                           TextTrimming="CharacterEllipsis"
                                           Margin="4,0,4,0"/>

                                <!-- 徽章 -->
                                <ctrl:SidebarBadge x:Name="Badge" Grid.Column="4"
                                                   BadgeType="{Binding BadgeType}"
                                                   Count="{Binding BadgeCount}"
                                                   Text="{Binding BadgeText}"
                                                   BadgeBrush="{Binding BadgeBrush}"
                                                   VerticalAlignment="Center"
                                                   Margin="0,0,4,0"/>

                                <!-- 展开箭头 -->
                                <Path x:Name="ExpandArrow" Grid.Column="5"
                                      Opacity="0.92"
                                      Data="M8 4l8 8-8 8"
                                      Stroke="{DynamicResource Sidebar.ExpandArrowBrush}"
                                      StrokeThickness="1.5"
                                      Width="8" Height="8"
                                      Stretch="Uniform"
                                      VerticalAlignment="Center"
                                      HorizontalAlignment="Center"
                                      Margin="0,0,10,0"
                                      RenderTransformOrigin="0.5,0.5"
                                      Visibility="{Binding HasChildren, Converter={StaticResource BoolToVis_Item}}">
                                    <Path.RenderTransform>
                                        <RotateTransform Angle="0"/>
                                    </Path.RenderTransform>
                                </Path>
                            </Grid>
                        </Border>

                        <!-- 子项容器 -->
                        <Border x:Name="ChildrenContainer" Opacity="0" MaxHeight="0" ClipToBounds="True">
                            <ItemsControl x:Name="ChildrenHost"
                                      ItemsSource="{Binding Children}"
                                      Visibility="Collapsed">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:SidebarItemViewModel}">
                                    <ctrl:SidebarNavItem DataContext="{Binding}"
                                                         Visibility="{Binding IsVisibleInSearch, Converter={StaticResource BoolToVis_Item}}"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>

                    <ControlTemplate.Triggers>
                        <!-- ═══ 迷你模式 ═══ -->
                        <DataTrigger Binding="{Binding IsExpanded, RelativeSource={RelativeSource AncestorType={x:Type ctrl:SidebarNavigation}}}" Value="False">
                            <Setter TargetName="TitleText" Property="Visibility" Value="Collapsed"/>
                            <Setter TargetName="Badge" Property="Visibility" Value="Collapsed"/>
                            <Setter TargetName="ExpandArrow" Property="Visibility" Value="Collapsed"/>
                            <Setter TargetName="ChildrenHost" Property="Visibility" Value="Collapsed"/>
                            <Setter TargetName="ChildrenContainer" Property="MaxHeight" Value="0"/>
                            <Setter TargetName="ChildrenContainer" Property="Opacity" Value="0"/>
                            <Setter TargetName="IndentBorder" Property="Width" Value="0"/>
                            <Setter TargetName="Indicator" Property="Visibility" Value="Collapsed"/>
                            <Setter TargetName="ItemBorder" Property="Margin" Value="6,1"/>
                            <Setter TargetName="ItemBorder" Property="MinHeight" Value="42"/>
                            <Setter TargetName="ItemBorder" Property="HorizontalAlignment" Value="Center"/>
                            <!-- 迷你模式下 ToolTip 显示标题 -->
                            <Setter Property="ToolTip" Value="{Binding Title}"/>
                            <Setter Property="ToolTipService.Placement" Value="Right"/>
                            <Setter Property="ToolTipService.HorizontalOffset" Value="4"/>
                            <Setter Property="ToolTipService.InitialShowDelay" Value="200"/>
                        </DataTrigger>

                        <!-- ═══ 悬停 ═══ -->
                        <Trigger SourceName="ItemBorder" Property="IsMouseOver" Value="True">
                            <Setter TargetName="ItemBorder" Property="Background" Value="{DynamicResource Sidebar.Item.HoverBrush}"/>
                            <Setter TargetName="PathIcon" Property="Fill" Value="{DynamicResource Sidebar.IconActiveBrush}"/>
                            <Setter TargetName="FontIcon" Property="Foreground" Value="{DynamicResource Sidebar.IconActiveBrush}"/>
                            <Trigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="ItemBorder" Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.12"/>
                                        <DoubleAnimation Storyboard.TargetName="ExpandArrow" Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.12"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </Trigger.EnterActions>
                            <Trigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="ItemBorder" Storyboard.TargetProperty="Opacity" To="0.97" Duration="0:0:0.18"/>
                                        <DoubleAnimation Storyboard.TargetName="ExpandArrow" Storyboard.TargetProperty="Opacity" To="0.92" Duration="0:0:0.18"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </Trigger.ExitActions>
                        </Trigger>

                        <!-- ═══ 选中 ═══ -->
                        <DataTrigger Binding="{Binding IsSelected}" Value="True">
                            <Setter TargetName="ItemBorder" Property="Background" Value="{DynamicResource Sidebar.Item.SelectedBrush}"/>
                            <Setter TargetName="TitleText" Property="Foreground" Value="{DynamicResource Sidebar.AccentBrush}"/>
                            <Setter TargetName="TitleText" Property="FontWeight" Value="SemiBold"/>
                            <Setter TargetName="PathIcon" Property="Fill" Value="{DynamicResource Sidebar.IconActiveBrush}"/>
                            <Setter TargetName="FontIcon" Property="Foreground" Value="{DynamicResource Sidebar.IconActiveBrush}"/>
                            <Setter TargetName="Indicator" Property="Opacity" Value="1"/>
                            <DataTrigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="Indicator" Storyboard.TargetProperty="Height" To="20" Duration="0:0:0.16">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseOut"/>
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.EnterActions>
                            <DataTrigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="Indicator" Storyboard.TargetProperty="Height" To="0" Duration="0:0:0.16">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseIn"/>
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                        <DoubleAnimation Storyboard.TargetName="Indicator" Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.16"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.ExitActions>
                        </DataTrigger>

                        <!-- ═══ 展开子项 ═══ -->
                        <DataTrigger Binding="{Binding IsExpanded}" Value="True">
                            <Setter TargetName="ChildrenHost" Property="Visibility" Value="Visible"/>
                            <DataTrigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="ChildrenContainer" Storyboard.TargetProperty="MaxHeight" To="800" Duration="0:0:0.2">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseOut"/>
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                        <DoubleAnimation Storyboard.TargetName="ChildrenContainer" Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.18"/>
                                        <DoubleAnimation Storyboard.TargetName="ExpandArrow" Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)" To="90" Duration="0:0:0.18">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseOut"/>
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.EnterActions>
                            <DataTrigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="ChildrenContainer" Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.14"/>
                                        <DoubleAnimation Storyboard.TargetName="ChildrenContainer" Storyboard.TargetProperty="MaxHeight" To="0" Duration="0:0:0.18">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseIn"/>
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                        <DoubleAnimation Storyboard.TargetName="ExpandArrow" Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)" To="0" Duration="0:0:0.18">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseInOut"/>
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ChildrenHost" Storyboard.TargetProperty="Visibility">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0.18" Value="{x:Static Visibility.Collapsed}"/>
                                        </ObjectAnimationUsingKeyFrames>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.ExitActions>
                        </DataTrigger>

                        <!-- ═══ 搜索高亮 ═══ -->
                        <DataTrigger Binding="{Binding IsSearchHighlighted}" Value="True">
                            <Setter TargetName="TitleText" Property="Foreground" Value="{DynamicResource Sidebar.SearchHighlightFg}"/>
                            <Setter TargetName="TitleText" Property="FontWeight" Value="Bold"/>
                        </DataTrigger>

                        <!-- ═══ 禁用 ═══ -->
                        <DataTrigger Binding="{Binding IsEnabled}" Value="False">
                            <Setter TargetName="TitleText" Property="Foreground" Value="{DynamicResource Sidebar.DisabledForeground}"/>
                            <Setter TargetName="PathIcon" Property="Fill" Value="{DynamicResource Sidebar.DisabledForeground}"/>
                            <Setter TargetName="FontIcon" Property="Foreground" Value="{DynamicResource Sidebar.DisabledForeground}"/>
                            <Setter Property="IsHitTestVisible" Value="False"/>
                            <Setter Property="Opacity" Value="0.5"/>
                        </DataTrigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

</ResourceDictionary>
